name: Pull Request Test

on: 
  pull_request:
    branches: 
      - main

jobs:
  build_linux:
    name: Build for linux
    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 4
      matrix:
        arch: [DEIGEN_DONT_VECTORIZE, msse2, mssse3, mavx, mavx2]
        os: [ubuntu-16.04, ubuntu-18.04]
    steps:        
    - uses: actions/checkout@v1
    - name: Install dependencies
      run: |
        git clone https://github.com/eigenteam/eigen-git-mirror
        cd eigen-git-mirror
        git checkout tags/3.3.7
        cd ..
        mv eigen-git-mirror include
    - name: Build Bench
      run: |
        g++ -std=c++11 -g -O3 -${{ matrix.arch }} -DNDEBUG -I./ -I./include -Wno-ignored-attributes test/benchmark.cpp -o bench.out
    - name: Run Bench
      run: |
        cat /proc/cpuinfo
        ./bench.out
    - name: Build Accuracy
      run: |
        g++ -std=c++11 -g -O3 -${{ matrix.arch }} -DNDEBUG -I./ -I./include -Wno-ignored-attributes test/accuracy.cpp -o accuracy.out
    - name: Run Accuracy
      run: |
        ./accuracy.out

  build_macos:
    name: Build for macOS
    runs-on: macOS-latest
    strategy:
      max-parallel: 4
      matrix:
        arch: [DEIGEN_DONT_VECTORIZE, msse2, mssse3, mavx]
    steps:
    - uses: actions/checkout@v1
    - name: Install dependencies
      run: |
        wget https://github.com/eigenteam/eigen-git-mirror/archive/3.3.7.tar.gz
        tar -zxvf 3.3.7.tar.gz
        mv eigen-git-mirror-3.3.7 include
    - name: Build Bench
      run: |
        g++ -std=c++11 -g -O3 -${{ matrix.arch }} -DNDEBUG -I./ -I./include -Wno-ignored-attributes test/benchmark.cpp -o bench.out
    - name: Run Bench
      continue-on-error: true
      run: |
        sysctl -a | grep machdep.cpu
        ./bench.out
    - name: Build Accuracy
      run: |
        g++ -std=c++11 -g -O3 -${{ matrix.arch }} -DNDEBUG -I./ -I./include -Wno-ignored-attributes test/accuracy.cpp -o accuracy.out
    - name: Run Accuracy
      run: |
        ./accuracy.out

  build_windows:
    name: Build for Windows
    runs-on: windows-latest
    strategy:
      max-parallel: 4
      matrix:
        arch: ['/D EIGEN_DONT_VECTORIZE', '/arch:SSE2', '/arch:AVX', '/arch:AVX2']
    steps:
    - uses: actions/checkout@v1
    - name: Install dependencies
      run: |
        Invoke-WebRequest -OutFile 3.3.7.tar.gz https://github.com/eigenteam/eigen-git-mirror/archive/3.3.7.tar.gz
        tar -zxvf 3.3.7.tar.gz
        mv eigen-git-mirror-3.3.7 include
    - uses: ilammy/msvc-dev-cmd@v1
    - name: Build Bench
      run: |
        cl.exe /O2 ${{ matrix.arch }} /I.\ /I.\include /D "NDEBUG" /Fe:bench.exe .\test\benchmark.cpp
    - name: Run Bench
      run: |
        bash -c "cat /proc/cpuinfo"
        .\bench.exe
    - name: Build Accuracy
      run: |
        cl.exe /O2 ${{ matrix.arch }} /I.\ /I.\include /D "NDEBUG" /Fe:accuracy.exe .\test\accuracy.cpp
    - name: Run Accuracy
      run: |
        .\accuracy.exe
